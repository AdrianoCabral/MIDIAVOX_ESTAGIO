<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>module_2_project</title>

	<script src="libraries/p5.js"></script>
	<script src="libraries/p5.dom.js"></script>
	<script src="libraries/p5.sound.js"></script>

    <style>
        th, td, p, input {
            font:14px Verdana;
        }
        table, th, td 
        {
            border: solid 1px #DDD;
            border-collapse: collapse;
            padding: 2px 3px;
            text-align: center;
        }
        th {
            font-weight:bold;
        }
    </style>
</head>
<body>
	
	<script></script>
	<h1> webservice app</h1>
	<div>
		<h2>Filtros</h2>
		<form>
			<label for="id">ID:</label><br>
			<input type ="text" id="id" /><br>
			<label for="destination">DESTINATION:</label><br>
			<input type ="text" id="destination"/><br>
			<input type="button" value="Aplicar" onclick="get_id()" />
			<input type="button" value="Limpar" onclick="get_all()" />
		</form>
	</div>
	<input type="button" onclick="get_data()" value="Create Table From Database"/>

	<p id="showData"></p>
</body>
<script>
	function send_coords(){
		lat = document.getElementById('lat').textContent;
		lon = document.getElementById('lon').textContent;
		lat = '2';
		lon = '3';
		const data = {lat,lon};
		fetch('/api', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(data)
		}).then( response =>{
			return	response.json();	
		}).then( response =>{
			console.log(response);
		});
	}
	function get_all(){
		fetch('/api')
		.then(response =>{
			return response.json();
		}).then(response =>{
			console.log(response);
			draw_table(response);
		})
		.catch(err =>{
			console.error(err);
		})	
	}

	function get_id(){
		id = document.getElementById('id').value;
		destination = document.getElementById('destination').value;
		console.log("id filtrado: " + id);
		if(id == ''){
			if(destination == ''){
				get_all();
			}
			else{
				console.log('requesting filter by destination');
				url = '/api/destination/' + destination;
				fetch(url)
				.then(response =>{
					return response.json();
				}).then(response =>{
					draw_table(response);
				})
				.catch(err =>{
					console.error(err);
				})	
			}
		}else{
			console.log("pq caralhos entrou aqui");
			url = '/api/' + id;
			fetch(url)
			.then(response =>{
				return response.json();
			}).then(response =>{
				console.log(response);
				draw_table(response);
			})
			.catch(err =>{
				console.error(err);
			})

		}
	}

	function draw_table(data){
		var col = [];
        for (var i = 0; i < data.length; i++) {
            for (var key in data[i]) {
                if (col.indexOf(key) === -1) {
                    col.push(key);
                }
            }
        }
		// CREATE DYNAMIC TABLE.
		var table = document.createElement("table");
		// CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

		var tr = table.insertRow(-1);                   // TABLE ROW.

        for (var i = 0; i < col.length; i++) {
            var th = document.createElement("th");      // TABLE HEADER.
			if(i = 0){
				value = "ID";
			}else{
				value = "DESTINATION";
			}
            th.innerHTML = value;
            tr.appendChild(th);
        }

        // ADD JSON DATA TO THE TABLE AS ROWS.
		for (var i = 0; i < data.length; i++) {

			tr = table.insertRow(-1);

			for (var j = 0; j < col.length; j++) {
				var tabCell = tr.insertCell(-1);
				tabCell.innerHTML = data[i][col[j]];
			}
			var button =document.createElement("button");
			button.innerHTML = "delete";
			button.addEventListener("click",delete_id);
			var tabCell = tr.insertCell(-1);
			tabCell.appendChild(button);
		}

		// FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
		var divContainer = document.getElementById("showData");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);

	}
</script>
</html>
